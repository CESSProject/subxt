name: Rust

on:
    push:
        # Run jobs when commits are pushed to
        # master or release-like branches:
        branches:
            - master
    pull_request:
        # Run jobs for any external PR that wants
        # to merge to master, too:
        branches:
            - master

concurrency:
    group: ${{ github.ref }}-${{ github.workflow }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always
    # Increase wasm test timeout from 20 seconds (default) to 1 minute.
    WASM_BINDGEN_TEST_TIMEOUT: 60

jobs:
    unstable_backend_tests1:
        name: "Test (Unstable Backend) 1"
        runs-on: ubuntu-latest-16-cores
        timeout-minutes: 15
        steps:
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Use substrate-node binary
              uses: ./.github/workflows/actions/use-substrate

            - name: Install Rust stable toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Rust Cache
              uses: Swatinem/rust-cache@23bce251a8cd2ffc3c1075eaa2367cf899916d84 # v2.7.3

            - name: Install cargo-nextest
              run: cargo install cargo-nextest

            - name: Run tests
              uses: actions-rs/cargo@v1.0.3
              with:
                  command: nextest
                  args: run --workspace --features unstable-backend-client --no-capture
    unstable_backend_tests2:
        name: "Test (Unstable Backend) 2"
        runs-on: ubuntu-latest-16-cores
        timeout-minutes: 15
        steps:
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Use substrate-node binary
              uses: ./.github/workflows/actions/use-substrate

            - name: Install Rust stable toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Rust Cache
              uses: Swatinem/rust-cache@23bce251a8cd2ffc3c1075eaa2367cf899916d84 # v2.7.3

            - name: Install cargo-nextest
              run: cargo install cargo-nextest

            - name: Run tests
              uses: actions-rs/cargo@v1.0.3
              with:
                  command: nextest
                  args: run --workspace --features unstable-backend-client --no-capture
    unstable_backend_tests3:
        name: "Test (Unstable Backend) 3"
        runs-on: ubuntu-latest-16-cores
        timeout-minutes: 15
        steps:
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Use substrate-node binary
              uses: ./.github/workflows/actions/use-substrate

            - name: Install Rust stable toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Rust Cache
              uses: Swatinem/rust-cache@23bce251a8cd2ffc3c1075eaa2367cf899916d84 # v2.7.3

            - name: Install cargo-nextest
              run: cargo install cargo-nextest

            - name: Run tests
              uses: actions-rs/cargo@v1.0.3
              with:
                  command: nextest
                  args: run --workspace --features unstable-backend-client --no-capture
